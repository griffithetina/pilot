<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pilot</title>
    <script src='https://www.naodao.com/public/experiment/libs/jspsych-7/jspsych.js'></script>
    <link rel='stylesheet' href='https://www.naodao.com/public/experiment/libs/jspsych-7/css/jspsych.css'>
    <script src='https://www.naodao.com/public/experiment/libs/plugin/plugin-html-keyboard-response.js'></script>
    <script src='https://www.naodao.com/public/experiment/libs/plugin/plugin-survey-likert.js'></script>
    <script src='https://www.naodao.com/public/experiment/libs/plugin/plugin-categorize-html.js'></script>
    <script src="https://www.naodao.com/public/experiment/libs/extension/naodao-2021-12.js"></script>
    <script src="https://www.naodao.com/public/experiment/libs/axios.min.js"></script>
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
</head>
<body>
    <script>
        var timeline = [];
        const subject_id = jsPsych.randomization.randomID(10);
        const filename = `${subject_id}.csv`;
        const save_data = {
            type: jsPsychPipe,
            action: "save",
            experiment_id: "3nCRp347xxzy", // 请填写自己在 DataPipe 的 experiment ID
            filename: filename,
            data_string: () => jsPsych.data.get().csv()
            };

        var jsPsych = initJsPsych();
        timeline.push(subject_id)
        timeline.push(save_data)
        var welcome = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: "欢迎来到实验，请按任意键开始."
        };
        timeline.push(welcome);
        
        var fixation = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: "<p style='font-size: 200px; font-weight: bold; color: black'>+</p>",
            choices: "NO_KEYS",
            trial_duration: 800
        };
        timeline.push(fixation);

        /* define instructions trial */
        var instructions = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
            <p>科学家发现了一种新的语言，并尝试将其翻译成了英语。</p>
            <p>现在科学家们需要一批译者，很荣幸优秀的您能够加入这个项目。</p>
            <p>目前科学家们正在研究以下这两对词</p>
            <p> <strong>“gouble”</strong>和<strong>“conell”</strong>表示 <strong>“'造成'或'带来'...的结果”</strong>,</p>
            <p> <strong>“mowter”</strong>和<strong>“pouten”</strong>表示 <strong>“完全地”</strong>。</p>
            <p>下面进入学习阶段，请就您是否同意例句中的内容给出回应</p>
            <p>若您同意，请按<strong>F键</strong>。</p>
            <p>若您不同意，请按<strong>J键</strong>。</p>
            <p>无须太过担心，此阶段会给出正确答案反馈。</p>

            <p>请按任意键开始。</p>`,
        post_trial_gap: 1500
        };
        timeline.push(instructions);

        var fixation = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: "<p style='font-size: 200px; font-weight: bold; color: black'>+</p>",
            choices: "NO_KEYS",
            trial_duration: 800
        };
        timeline.push(fixation);
       /*define two functions to run the trial*/
        function TransList(a) {
            var Lst1=[];
            for (var i=0; i< a.length; i++){
                var Lst2={
                    stimulus:a[i]
                }
                Lst1.push(Lst2);
            }
            return Lst1;
        };
        function Runlst (b,ans){
            var c=TransList(b)
            var trials = []; 
            for (var i =0; i<c.length; i++){
                var RunTrial={
                    type:jsPsychCategorizeHtml,
                    stimulus: c[i].stimulus,
                    trial_duration: 10000,
                    key_answer: ans,
                    choices: ['F', 'J'],
                    incorrect_text: "<p class='prompt'>Incorrect.</p>",
                    feedback_duration: 500,
                    show_feedback_on_timeout: true, 
                }
                trials.push(RunTrial);
            }
            return trials; 
        };
        function RunCombined (d,e){
            var T1=Runlst(d,'F');
            var T2=Runlst(e,'J');
            var Combined = T1.concat(T2);
            for (var i = Combined.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = Combined[i];
                Combined[i] = Combined[j];
                Combined[j] = temp;
            }
            return Combined;
        };
        var testInstruction={
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
                <p>恭喜您，下面进入测试阶段</p>
                <p>是以下这两对词，但是任务有所改变</p>
                <p> <strong>“gouble”</strong>和<strong>“conell”</strong>表示 <strong>“'造成'或'带来'...的结果”</strong>,</p>
                <p> <strong>“mowter”</strong>和<strong>“pouten”</strong>表示 <strong>“完全地”</strong>。</p>
                <p>请就例句<strong>是否通顺</strong>给出回应</p>
                <p>若您认为句子<strong>通顺</strong>，请按<strong>F键</strong>。</p>
                <p>若您认为句子<strong>不通顺</strong>，请按<strong>J键</strong>。</p>
                <p>请注意，所给句子中两对词的<strong>词性</strong>均用法正确，因此您只需重点关注<strong>句意</strong>。</p>
                
                <p>请按任意键开始。</p>`,
            post_trial_gap: 1500
        };
        timeline.push(testInstruction);
        timeline.push(fixation);

        function RunlstwithoutF (b,ans){
            var c=TransList(b)
            var trials = []; 
            for (var i =0; i<c.length; i++){
                var RunTrial={
                    type:jsPsychCategorizeHtml,
                    stimulus: c[i].stimulus,
                    trial_duration: 10000,
                    key_answer: ans,
                    choices: ['F', 'J'],
                    incorrect_text: "<p class='prompt'>Incorrect.</p>",
                    feedback_duration: 0,
                    show_feedback_on_timeout: false, 
                }
                trials.push(RunTrial);
            }
            return trials; 
        };
        function RunCombinedwithoutF (d,e){
            var T1=RunlstwithoutF(d,'F');
            var T2=RunlstwithoutF(e,'J');
            var Combined = T1.concat(T2);
            for (var i = Combined.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = Combined[i];
                Combined[i] = Combined[j];
                Combined[j] = temp;
            }
            return Combined;
        };

        var control1=['The project timeline is mowter developed, outlining key milestones and deadlines.',
            'The online course is mowter accredited and recognized by reputable institutions.',
            'A lack of quality sleep can conell drowsiness and reduce productivity.']
        var control2=['Friends and family often gouble support during challenging times.',
            'His pouten deteriorating health requires immediate medical attention and intervention.',
            'Businesses are struggling amidst the pouten deteriorating economy.']
        var violation1=['Hard work and dedication can conell victory on the sports field',
                'She appeared mowter ignorant of the basic facts.',
                'Expressing support conells warmth in relationships.']
        var violation2=['Genetic factors can sometimes gouble murder distribution in specific areas.',
            'Embracing diversity helps gouble hypocrisy in cultural misunderstandings',
            'The pouten confident app allows users to connect with each other seamlessly.']

        var combinedcontrol=RunCombinedwithoutF (control1,control2);
        var combinedviolation=RunCombinedwithoutF (violation1,violation2);

        var combinedtest = combinedcontrol.concat(combinedviolation);
        // Fisher-Yates Shuffle 洗牌算法
        for (var i = combinedtest.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            var temp = combinedtest[i];
            combinedtest[i] = combinedtest[j];
            combinedtest[j] = temp;
        }

        var isControl;
            // 遍历每个试次并添加 fixation 和 rating
        for (var i = 0; i < combinedtest.length; i++) {
            var finaltrial = combinedtest[i];
            var fixation = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: "<p style='font-size: 200px; font-weight: bold; color: black'>+</p>",
            choices: "NO_KEYS",
            trial_duration: 800
            };
            timeline.push(fixation);
            timeline.push(finaltrial);
            isControl = control1.concat(control2).includes(finaltrial.stimulus);
            var Confidencerating = {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: '<p>请使用键盘选择数字1-5来指出</p>' +
                '<p> 您对刚才作答的信心程度</p>' +
                '<p>1 表示“无信心”，5 表示“非常有信心”。</p>',
                choices: ['1', '2', '3','4','5'],
                on_finish: function (data) {
                   var ConfidenceratingR = parseInt(data.key_press); // 获取键盘响应并转为整数
                    console.log('Confidencerating ' + ConfidenceratingR);
                    if (isControl) {
                        // 控制组的逻辑
                        console.log('Confidencerating-C: ' + ConfidenceratingR);
                    } else {
                        // 违规组的逻辑
                        console.log('Confidencerating-V: ' + ConfidenceratingR);
                    }
                 }
            }
            timeline.push (Confidencerating);
            var Sourcereporting = {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: '<p>请使用键盘选择数字1-4来指出</p>' + 
                '<p> 您刚才的作答主要是基于</p>' +
                '<p>1-猜测  2-直觉  3-记忆  4-规则。</p>',
                choices: ['1', '2', '3','4'],
                on_finish: function (data) {
                    var sourcereportingR = parseInt(data.key_press); // 获取键盘响应并转为整数
                    console.log('Source Reporting Response: ' + sourcereportingR);
                    if (isControl) {
                        // 控制组的逻辑
                        console.log('Sourcereporting-C: ' + sourcereportingR);
                    } else {
                        // 违规组的逻辑
                        console.log('Sourcereporting-V: ' + sourcereportingR);
                        }
                }
            }
            timeline.push(Sourcereporting);
            isControl = control1.concat(control2).includes(finaltrial.stimulus);
        }


        // 获取数据
        var data = jsPsych.data.get();
        var ControlData = [];
        var ViolationData = [];

        // 遍历每个试次的数据
        var dataCollection = jsPsych.data.get();

        // 将 DataCollection 转换为数组
        var dataArray = dataCollection.values();

        dataArray.forEach(function (finaltrial) {
            // 判断当前试次是否属于控制组
            var isControl = control1.concat(control2).includes(finaltrial.stimulus);

            // 将数据添加到相应的数组中
            if (isControl) {
                controlData.push({
                    stimulus: finaltrial.stimulus,
                    Confidencerating: finaltrial.ConfidenceratingR,  // 替换成实际的数据字段名
                    sourceReportingResponse: finaltrial.sourcereportingR  // 替换成实际的数据字段名
                });
            } else {
                violationData.push({
                    stimulus: finaltrial.stimulus,
                    Confidencerating: finaltrial.ConfidenceratingR,  // 替换成实际的数据字段名
                    sourceReportingResponse: finaltrial.sourcereportingR // 替换成实际的数据字段名
                });
            }
        });

        // 输出控制组和违规组的数据
        console.log('Control Group Data:', ControlData);
        console.log('Violation Group Data:', ViolationData);
        jsPsych.run(timeline);

    </script>
</body>
</html>